<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TownSqr - Social Media Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1d29;
        }
        #feed-container::-webkit-scrollbar {
            width: 8px;
        }
        #feed-container::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        #feed-container::-webkit-scrollbar-track {
            background-color: #2d3142;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
        .avatar-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start py-8">

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal active fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-[#252836] rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 border border-indigo-800/50">
            <h2 class="text-2xl font-bold text-gray-100 mb-6 text-center">Welcome to TownSqr</h2>
            
            <div id="register-form">
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-medium mb-2">Choose a Username</label>
                    <input
                        type="text"
                        id="username-input"
                        placeholder="username"
                        autocomplete="off"
                        class="w-full p-3 text-gray-100 bg-[#1e2130] border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                        maxlength="20"
                    >
                    <p id="username-status" class="text-xs mt-1 text-gray-400"></p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-medium mb-2">Select Your School</label>
                    <select
                        id="school-select"
                        class="w-full p-3 text-gray-100 bg-[#1e2130] border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                    >
                        <option value="">Choose your school...</option>
                        <option value="central university">üèõÔ∏è Central University</option>
                        <option value="ashesi university">üéì Ashesi University</option>
                        <option value="knust">üìö KNUST</option>
                        <option value="university of ghana">üè´ University of Ghana</option>
                        <option value="upsa">üéØ UPSA</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-medium mb-2">Profile Picture (Optional)</label>
                    <div class="flex items-center gap-4">
                        <div id="avatar-preview" class="avatar-placeholder">?</div>
                        <input
                            type="file"
                            id="avatar-input"
                            accept="image/*"
                            class="hidden"
                        >
                        <button
                            type="button"
                            id="avatar-upload-btn"
                            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition duration-150"
                        >
                            Upload
                        </button>
                    </div>
                </div>
                
                <button
                    id="register-btn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg disabled:bg-indigo-900 disabled:text-gray-500"
                    disabled
                >
                    Join TownSqr
                </button>
            </div>
        </div>
    </div>

    <div id="main-content" class="w-full max-w-lg hidden">
        <header class="text-center mb-6">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-3xl font-bold text-gray-100">Town Square <span class="text-indigo-400">üõñüí¨</span></h1>
                <div class="flex items-center gap-2">
                    <img id="user-avatar" src="" alt="" class="w-10 h-10 rounded-full hidden border-2 border-indigo-500">
                    <div id="user-avatar-placeholder" class="avatar-placeholder">?</div>
                    <button
                        id="logout-btn"
                        class="px-3 py-1 text-xs bg-red-600 hover:bg-red-700 text-white rounded-lg transition duration-150"
                    >
                        Logout
                    </button>
                </div>
            </div>
            <p id="user-info" class="text-sm text-gray-400 mt-1"></p>
        </header>

        <div id="connection-status" class="text-center py-2 px-4 mb-4 text-xs font-medium rounded-lg shadow-sm">
            Attempting to connect...
        </div>

        <div id="room-selector" class="mb-4 flex flex-wrap gap-2 justify-center">
            <button class="room-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-150 bg-indigo-600 text-white border border-indigo-500" data-room="general">üí¨ General</button>
            <button class="room-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-150 bg-[#252836] text-gray-300 border border-gray-600 hover:bg-indigo-900/30 hover:border-indigo-600" data-room="central university">üèõÔ∏è Central University</button>
            <button class="room-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-150 bg-[#252836] text-gray-300 border border-gray-600 hover:bg-indigo-900/30 hover:border-indigo-600" data-room="ashesi university">üéì Ashesi University</button>
            <button class="room-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-150 bg-[#252836] text-gray-300 border border-gray-600 hover:bg-indigo-900/30 hover:border-indigo-600" data-room="knust">üìö KNUST</button>
            <button class="room-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-150 bg-[#252836] text-gray-300 border border-gray-600 hover:bg-indigo-900/30 hover:border-indigo-600" data-room="university of ghana">üè´ University of Ghana</button>
            <button class="room-btn px-4 py-2 rounded-lg text-sm font-medium transition duration-150 bg-[#252836] text-gray-300 border border-gray-600 hover:bg-indigo-900/30 hover:border-indigo-600" data-room="upsa">üéØ UPSA</button>
        </div>

        <div id="current-room" class="text-center mb-4 text-sm text-indigo-400 font-medium">
            welcome to TownSqr charley, be a good boy/ girl.
        </div>

        <form id="post-form" class="flex flex-col gap-2 p-4 bg-[#252836] rounded-xl shadow-xl border border-indigo-800/50 mb-6">
            <div class="flex gap-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="What's happening?"
                    autocomplete="off"
                    class="flex-grow p-3 text-gray-100 bg-[#1e2130] border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 disabled:bg-gray-800 disabled:text-gray-500 placeholder-gray-500"
                    required
                    disabled
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg disabled:bg-indigo-900 disabled:text-gray-500"
                    disabled
                >
                    Post
                </button>
            </div>
            <div class="flex gap-2">
                <input
                    type="file"
                    id="image-input"
                    accept="image/*"
                    class="hidden"
                >
                <button
                    type="button"
                    id="image-upload-btn"
                    class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition duration-150 disabled:bg-gray-800 disabled:text-gray-500"
                    disabled
                >
                    üì∑ Add Image
                </button>
                <div id="image-preview" class="hidden">
                    <img id="preview-img" src="" alt="Preview" class="max-h-20 rounded-lg">
                    <button type="button" id="remove-image" class="text-red-400 hover:text-red-300 ml-2">‚úï</button>
                </div>
            </div>
            <select
                id="room-select"
                class="p-2 text-gray-100 bg-[#1e2130] border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 disabled:bg-gray-800 disabled:text-gray-500"
                disabled
            >
                <option value="general">üí¨ General (Everyone can see)</option>
            </select>
        </form>

        <div id="feed-container" class="bg-[#252836] p-4 rounded-xl shadow-lg h-[60vh] overflow-y-auto mb-6 border border-gray-700 space-y-4">
            <p class="text-center text-gray-500 p-8">Waiting for connection to server...</p>
        </div>
    </div>

    <footer class="mt-8 text-center text-gray-400 text-sm">
        <p>Made with ‚ù§Ô∏è ,charley.</p>
        <p>est. 2025</p>
    </footer>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script>
        // Global state
        let currentUser = null;
        let currentRoom = 'general';
        let selectedImage = null;
        let postElements = new Map();
        let socket = null;

        // DOM elements
        const authModal = document.getElementById('auth-modal');
        const mainContent = document.getElementById('main-content');
        const usernameInput = document.getElementById('username-input');
        const usernameStatus = document.getElementById('username-status');
        const schoolSelect = document.getElementById('school-select');
        const avatarInput = document.getElementById('avatar-input');
        const avatarUploadBtn = document.getElementById('avatar-upload-btn');
        const avatarPreview = document.getElementById('avatar-preview');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userAvatarPlaceholder = document.getElementById('user-avatar-placeholder');
        const feedContainer = document.getElementById('feed-container');
        const postForm = document.getElementById('post-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const connectionStatus = document.getElementById('connection-status');
        const roomSelect = document.getElementById('room-select');
        const currentRoomDisplay = document.getElementById('current-room');
        const roomButtons = document.querySelectorAll('.room-btn');
        const imageInput = document.getElementById('image-input');
        const imageUploadBtn = document.getElementById('image-upload-btn');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const removeImageBtn = document.getElementById('remove-image');

        // Get server URL
        const getServerUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const serverParam = urlParams.get('server');
            if (serverParam) {
                localStorage.setItem('serverUrl', serverParam);
                return serverParam;
            }
            
            const savedUrl = localStorage.getItem('serverUrl');
            if (savedUrl) {
                return savedUrl;
            }
            
            if (window.location.protocol !== 'file:') {
                const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
                const hostname = window.location.hostname;
                const port = window.location.port;
                
                const isFrontendCloudPlatform = hostname.includes('netlify.app') ||
                                               hostname.includes('vercel.app') ||
                                               hostname.includes('github.io') ||
                                               hostname.includes('firebaseapp.com');
                
                if (isFrontendCloudPlatform) {
                    return 'https://townsqr-3.onrender.com';
                }
                
                const isBackendCloudPlatform = hostname.includes('onrender.com') || 
                                               hostname.includes('railway.app') || 
                                               hostname.includes('herokuapp.com');
                
                if (isBackendCloudPlatform) {
                    return `${protocol}//${hostname}`;
                }
                
                if (!port || port === '80' || port === '443') {
                    return `${protocol}//${hostname}:3000`;
                }
                return `${protocol}//${hostname}:${port}`;
            }
            
            return 'https://townsqr-3.onrender.com';
        };

        const SERVER_URL = getServerUrl();
        const API_URL = SERVER_URL;

        // Check if user is already logged in
        const savedUser = localStorage.getItem('townsqr_user');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                initSocket();
            } catch (e) {
                localStorage.removeItem('townsqr_user');
            }
        }

        // Username validation
        let usernameCheckTimeout;
        usernameInput.addEventListener('input', () => {
            clearTimeout(usernameCheckTimeout);
            const username = usernameInput.value.trim().toLowerCase();
            
            if (username.length < 3) {
                usernameStatus.textContent = 'Username must be at least 3 characters';
                usernameStatus.className = 'text-xs mt-1 text-yellow-400';
                registerBtn.disabled = true;
                return;
            }
            
            if (username.length > 20) {
                usernameStatus.textContent = 'Username must be less than 20 characters';
                usernameStatus.className = 'text-xs mt-1 text-yellow-400';
                registerBtn.disabled = true;
                return;
            }
            
            if (!/^[a-z0-9_]+$/.test(username)) {
                usernameStatus.textContent = 'Only letters, numbers, and underscores allowed';
                usernameStatus.className = 'text-xs mt-1 text-yellow-400';
                registerBtn.disabled = true;
                return;
            }
            
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_URL}/api/check-username/${username}`);
                    const data = await response.json();
                    usernameStatus.textContent = data.message;
                    usernameStatus.className = `text-xs mt-1 ${data.available ? 'text-green-400' : 'text-red-400'}`;
                    updateRegisterButton();
                } catch (error) {
                    console.error('Error checking username:', error);
                }
            }, 500);
        });

        schoolSelect.addEventListener('change', updateRegisterButton);

        function updateRegisterButton() {
            const username = usernameInput.value.trim();
            const school = schoolSelect.value;
            const usernameValid = username.length >= 3 && username.length <= 20 && /^[a-z0-9_]+$/.test(username.toLowerCase());
            registerBtn.disabled = !(usernameValid && school);
        }

        // Avatar upload
        avatarUploadBtn.addEventListener('click', () => avatarInput.click());
        avatarInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                avatarPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full rounded-full object-cover">`;
            };
            reader.readAsDataURL(file);
        });

        // Register user
        registerBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const school = schoolSelect.value;
            
            if (!username || !school) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                // Register user
                const formData = new FormData();
                formData.append('username', username);
                formData.append('school', school);
                
                const response = await fetch(`${API_URL}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, school })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(data.error || 'Registration failed');
                    return;
                }
                
                currentUser = data.user;
                localStorage.setItem('townsqr_user', JSON.stringify(currentUser));
                
                // Upload avatar if selected
                if (avatarInput.files[0]) {
                    const avatarFormData = new FormData();
                    avatarFormData.append('avatar', avatarInput.files[0]);
                    avatarFormData.append('username', username);
                    
                    try {
                        const avatarResponse = await fetch(`${API_URL}/api/upload-avatar`, {
                            method: 'POST',
                            body: avatarFormData
                        });
                        const avatarData = await avatarResponse.json();
                        if (avatarData.success) {
                            currentUser.avatar = avatarData.avatar;
                            localStorage.setItem('townsqr_user', JSON.stringify(currentUser));
                        }
                    } catch (error) {
                        console.error('Error uploading avatar:', error);
                    }
                }
                
                // Hide modal and show main content
                authModal.classList.remove('active');
                mainContent.classList.remove('hidden');
                
                // Initialize socket connection
                initSocket();
                
            } catch (error) {
                console.error('Registration error:', error);
                alert('Failed to register. Please try again.');
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
            }
            localStorage.removeItem('townsqr_user');
            currentUser = null;
            authModal.classList.add('active');
            mainContent.classList.add('hidden');
            feedContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Waiting for connection to server...</p>';
        });

        // Initialize Socket.IO
        function initSocket() {
            socket = io(SERVER_URL);
            
            socket.on('connect', () => {
                updateStatus('Connected!', 'bg-green-900/30 text-green-400 border border-green-800/50', true);
                
                // Authenticate
                socket.emit('authenticate', { username: currentUser.username });
                
                // Update UI
                userInfo.textContent = `@${currentUser.displayName || currentUser.username} ‚Ä¢ ${getSchoolDisplayName(currentUser.school)}`;
                
                if (currentUser.avatar) {
                    userAvatar.src = `${API_URL}${currentUser.avatar}`;
                    userAvatar.classList.remove('hidden');
                    userAvatarPlaceholder.classList.add('hidden');
                } else {
                    userAvatarPlaceholder.textContent = (currentUser.displayName || currentUser.username)[0].toUpperCase();
                }
                
                // Update room select with user's school
                updateRoomSelect();
                
                // Join general room by default
                joinRoom('general');
            });
            
            socket.on('authenticated', () => {
                console.log('Authenticated successfully');
            });
            
            socket.on('auth_error', (data) => {
                alert(data.message || 'Authentication failed');
                localStorage.removeItem('townsqr_user');
                location.reload();
            });
            
            socket.on('room_joined', (roomName) => {
                currentRoom = roomName;
            });
            
            socket.on('initial_posts', (posts) => {
                feedContainer.innerHTML = '';
                postElements.clear();
                
                if (posts && posts.length > 0) {
                    posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    posts.forEach(post => {
                        renderPost(post);
                    });
                }
            });
            
            socket.on('new_post', (data) => {
                if (data.room !== currentRoom && currentRoom !== 'general') {
                    return;
                }
                renderPost(data);
            });
            
            socket.on('post_replied', (data) => {
                const postElement = postElements.get(data.postId);
                if (postElement) {
                    addReplyToPost(postElement, data.reply);
                }
            });
            
            socket.on('post_deleted', (postId) => {
                const postElement = postElements.get(postId);
                if (postElement) {
                    postElement.style.opacity = '0';
                    postElement.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        postElement.remove();
                        postElements.delete(postId);
                    }, 200);
                }
            });
            
            socket.on('error', (data) => {
                alert(data.message || 'An error occurred');
            });
            
            socket.on('disconnect', () => {
                updateStatus('Disconnected. Please refresh.', 'bg-red-900/30 text-red-400 border border-red-800/50', false);
            });
            
            socket.on('connect_error', (err) => {
                updateStatus(`Connection Error: Check if server is running on ${SERVER_URL}`, 'bg-yellow-900/30 text-yellow-400 border border-yellow-800/50', false);
                console.error('Socket.IO Connection Error:', err);
            });
        }

        function updateRoomSelect() {
            roomSelect.innerHTML = '<option value="general">üí¨ General (Everyone can see)</option>';
            
            if (currentUser && currentUser.school) {
                const schoolOption = document.createElement('option');
                schoolOption.value = currentUser.school;
                schoolOption.textContent = `${getSchoolEmoji(currentUser.school)} ${getSchoolDisplayName(currentUser.school)} (School only)`;
                roomSelect.appendChild(schoolOption);
            }
        }

        function getSchoolDisplayName(school) {
            const names = {
                'general': 'General',
                'central university': 'Central University',
                'ashesi university': 'Ashesi University',
                'knust': 'KNUST',
                'university of ghana': 'University of Ghana',
                'upsa': 'UPSA'
            };
            return names[school] || school;
        }

        function getSchoolEmoji(school) {
            const emojis = {
                'general': 'üí¨',
                'central university': 'üèõÔ∏è',
                'ashesi university': 'üéì',
                'knust': 'üìö',
                'university of ghana': 'üè´',
                'upsa': 'üéØ'
            };
            return emojis[school] || 'üè´';
        }

        function updateStatus(message, className, enableControls = false) {
            connectionStatus.textContent = message;
            connectionStatus.className = `text-center py-2 px-4 mb-4 text-xs font-medium rounded-lg shadow-sm ${className}`;
            
            messageInput.disabled = !enableControls;
            sendButton.disabled = !enableControls;
            roomSelect.disabled = !enableControls;
            imageUploadBtn.disabled = !enableControls;
            
            roomButtons.forEach(btn => {
                btn.disabled = !enableControls;
            });
        }

        function joinRoom(roomName) {
            if (!socket || !socket.connected) return;
            
            currentRoom = roomName;
            socket.emit('join_room', roomName);
            
            roomButtons.forEach(btn => {
                if (btn.getAttribute('data-room') === roomName) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-500');
                    btn.classList.remove('bg-[#252836]', 'text-gray-300', 'border-gray-600');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-500');
                    btn.classList.add('bg-[#252836]', 'text-gray-300', 'border-gray-600');
                }
            });
            
            roomSelect.value = roomName;
            currentRoomDisplay.textContent = `Current Room: ${getSchoolEmoji(roomName)} ${getSchoolDisplayName(roomName)}`;
            
            feedContainer.innerHTML = '';
            postElements.clear();
        }

        roomButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const roomName = btn.getAttribute('data-room');
                if (roomName === 'general' || roomName === currentUser?.school) {
                    joinRoom(roomName);
                } else {
                    alert('You can only access General room and your school room');
                }
            });
        });

        roomSelect.addEventListener('change', (e) => {
            joinRoom(e.target.value);
        });

        // Image upload
        imageUploadBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }
            
            selectedImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        removeImageBtn.addEventListener('click', () => {
            selectedImage = null;
            imageInput.value = '';
            imagePreview.classList.add('hidden');
        });

        // Post form submission
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = messageInput.value.trim();
            const selectedRoom = roomSelect.value;

            if (!content && !selectedImage) {
                return;
            }

            if (!socket || !socket.connected) {
                alert('Not connected to server');
                return;
            }

            let imageUrl = null;

            // Upload image if selected
            if (selectedImage) {
                try {
                    const formData = new FormData();
                    formData.append('image', selectedImage);
                    
                    const response = await fetch(`${API_URL}/api/upload-post-image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        imageUrl = data.imageUrl;
                    } else {
                        alert('Failed to upload image');
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Failed to upload image');
                    return;
                }
            }

            const payload = {
                content: content,
                imageUrl: imageUrl,
                room: selectedRoom
            };

            socket.emit('new_post', payload);

            // Clear form
            messageInput.value = '';
            selectedImage = null;
            imageInput.value = '';
            imagePreview.classList.add('hidden');
        });

        // Render post
        function renderPost(data) {
            const post = document.createElement('div');
            const postId = data.id || `temp-${Date.now()}-${Math.random()}`;
            post.setAttribute('data-post-id', postId);
            post.setAttribute('data-room', data.room || currentRoom);
            
            post.classList.add('p-4', 'rounded-lg', 'break-words', 'shadow-sm', 'transition', 'duration-150', 'relative', 'group', 'bg-[#1e2130]', 'border', 'border-gray-700/50', 'mb-4');

            const isOwnPost = data.sender === currentUser?.username;
            const senderName = isOwnPost ? 'You' : (data.displayName || data.sender);
            const senderClass = isOwnPost ? 'font-bold text-indigo-400' : 'font-semibold text-gray-300';
            
            const avatarHtml = data.avatar 
                ? `<img src="${API_URL}${data.avatar}" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-500">`
                : `<div class="avatar-placeholder">${(data.displayName || data.sender)[0].toUpperCase()}</div>`;

            const timestamp = formatTimestamp(data.timestamp);
            const deleteButtonHtml = isOwnPost ? `
                <button 
                    class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-150 text-red-400 hover:text-red-300 bg-red-900/20 hover:bg-red-900/30 rounded-full p-1.5 text-xs font-semibold"
                    onclick="deletePost('${postId}')"
                    title="Delete post"
                >
                    ‚úï
                </button>
            ` : '';

            const imageHtml = data.imageUrl ? `
                <div class="mt-2">
                    <img src="${API_URL}${data.imageUrl}" alt="Post image" class="max-w-full rounded-lg">
                </div>
            ` : '';

            const repliesHtml = data.replies && data.replies.length > 0 ? `
                <div class="mt-3 pt-3 border-t border-gray-700 space-y-2">
                    ${data.replies.map(reply => {
                        const replyAvatar = reply.avatar 
                            ? `<img src="${API_URL}${reply.avatar}" class="w-8 h-8 rounded-full object-cover">`
                            : `<div class="avatar-placeholder" style="width: 32px; height: 32px; font-size: 12px;">${(reply.displayName || reply.sender)[0].toUpperCase()}</div>`;
                        const replyImage = reply.imageUrl ? `<img src="${API_URL}${reply.imageUrl}" alt="Reply image" class="max-w-full rounded-lg mt-1">` : '';
                        return `
                            <div class="flex gap-2">
                                ${replyAvatar}
                                <div class="flex-1">
                                    <div class="text-xs ${reply.sender === currentUser?.username ? 'text-indigo-400 font-bold' : 'text-gray-300 font-semibold'}">
                                        @${reply.displayName || reply.sender}
                                        <span class="text-gray-500 ml-2">${formatTimestamp(reply.timestamp)}</span>
                                    </div>
                                    <div class="text-gray-300 text-sm mt-1">${reply.content || ''}</div>
                                    ${replyImage}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : '';

            post.innerHTML = `
                ${deleteButtonHtml}
                <div class="flex gap-3">
                    ${avatarHtml}
                    <div class="flex-1">
                        <div class="${senderClass} text-sm mb-1 flex items-center flex-wrap">
                            @${senderName}
                            <span class="text-gray-500 text-xs ml-2">${timestamp}</span>
                        </div>
                        <p class="text-gray-200 mb-2">${data.content || ''}</p>
                        ${imageHtml}
                        ${repliesHtml}
                        <div class="mt-2">
                            <button 
                                onclick="showReplyForm('${postId}')"
                                class="text-xs text-indigo-400 hover:text-indigo-300 transition duration-150"
                            >
                                üí¨ Reply
                            </button>
                        </div>
                    </div>
                </div>
                <div id="reply-form-${postId}" class="hidden mt-3 pt-3 border-t border-gray-700">
                    <form onsubmit="submitReply(event, '${postId}')" class="flex flex-col gap-2">
                        <input
                            type="text"
                            id="reply-input-${postId}"
                            placeholder="Write a reply..."
                            class="p-2 text-gray-100 bg-[#252836] border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                            required
                        >
                        <div class="flex gap-2">
                            <input
                                type="file"
                                id="reply-image-${postId}"
                                accept="image/*"
                                class="hidden"
                            >
                            <button
                                type="button"
                                onclick="document.getElementById('reply-image-${postId}').click()"
                                class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition duration-150"
                            >
                                üì∑ Image
                            </button>
                            <button
                                type="submit"
                                class="px-4 py-1 text-xs bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition duration-150"
                            >
                                Reply
                            </button>
                            <button
                                type="button"
                                onclick="hideReplyForm('${postId}')"
                                class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition duration-150"
                            >
                                Cancel
                            </button>
                        </div>
                        <div id="reply-preview-${postId}" class="hidden mt-2">
                            <img id="reply-preview-img-${postId}" src="" alt="Preview" class="max-h-20 rounded-lg">
                        </div>
                    </form>
                </div>
            `;
            
            if (feedContainer.firstChild) {
                feedContainer.insertBefore(post, feedContainer.firstChild);
            } else {
                feedContainer.appendChild(post);
            }
            
            postElements.set(postId, post);
            feedContainer.scrollTop = 0;
        }

        function addReplyToPost(postElement, reply) {
            const repliesContainer = postElement.querySelector('.border-t.border-gray-700');
            if (!repliesContainer) {
                // Create replies container if it doesn't exist
                const postContent = postElement.querySelector('.flex-1');
                const replyButton = postContent.querySelector('button');
                const repliesDiv = document.createElement('div');
                repliesDiv.className = 'mt-3 pt-3 border-t border-gray-700 space-y-2';
                replyButton.parentElement.insertBefore(repliesDiv, replyButton);
            }
            
            const replyHtml = document.createElement('div');
            replyHtml.className = 'flex gap-2';
            const replyAvatar = reply.avatar 
                ? `<img src="${API_URL}${reply.avatar}" class="w-8 h-8 rounded-full object-cover">`
                : `<div class="avatar-placeholder" style="width: 32px; height: 32px; font-size: 12px;">${(reply.displayName || reply.sender)[0].toUpperCase()}</div>`;
            const replyImage = reply.imageUrl ? `<img src="${API_URL}${reply.imageUrl}" alt="Reply image" class="max-w-full rounded-lg mt-1">` : '';
            replyHtml.innerHTML = `
                ${replyAvatar}
                <div class="flex-1">
                    <div class="text-xs ${reply.sender === currentUser?.username ? 'text-indigo-400 font-bold' : 'text-gray-300 font-semibold'}">
                        @${reply.displayName || reply.sender}
                        <span class="text-gray-500 ml-2">${formatTimestamp(reply.timestamp)}</span>
                    </div>
                    <div class="text-gray-300 text-sm mt-1">${reply.content || ''}</div>
                    ${replyImage}
                </div>
            `;
            
            const container = postElement.querySelector('.border-t.border-gray-700');
            if (container) {
                container.appendChild(replyHtml);
            }
        }

        window.showReplyForm = function(postId) {
            const form = document.getElementById(`reply-form-${postId}`);
            if (form) {
                form.classList.remove('hidden');
            }
        };

        window.hideReplyForm = function(postId) {
            const form = document.getElementById(`reply-form-${postId}`);
            if (form) {
                form.classList.add('hidden');
                const input = document.getElementById(`reply-input-${postId}`);
                if (input) input.value = '';
                const preview = document.getElementById(`reply-preview-${postId}`);
                if (preview) preview.classList.add('hidden');
            }
        };

        window.submitReply = async function(e, postId) {
            e.preventDefault();
            const input = document.getElementById(`reply-input-${postId}`);
            const imageInput = document.getElementById(`reply-image-${postId}`);
            const content = input.value.trim();
            const imageFile = imageInput.files[0];

            if (!content && !imageFile) {
                return;
            }

            let imageUrl = null;

            if (imageFile) {
                try {
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    
                    const response = await fetch(`${API_URL}/api/upload-post-image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        imageUrl = data.imageUrl;
                    } else {
                        alert('Failed to upload image');
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Failed to upload image');
                    return;
                }
            }

            socket.emit('reply_to_post', {
                postId: postId,
                content: content,
                imageUrl: imageUrl
            });

            hideReplyForm(postId);
        };

        // Preview reply image
        document.addEventListener('change', (e) => {
            if (e.target.id && e.target.id.startsWith('reply-image-')) {
                const file = e.target.files[0];
                if (file) {
                    const postId = e.target.id.replace('reply-image-', '');
                    const preview = document.getElementById(`reply-preview-${postId}`);
                    const previewImg = document.getElementById(`reply-preview-img-${postId}`);
                    if (preview && previewImg) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            preview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        });

        window.deletePost = function(postId) {
            if (socket && socket.connected && postId) {
                const postElement = postElements.get(postId);
                if (postElement) {
                    const room = postElement.getAttribute('data-room');
                    socket.emit('delete_post', { postId, room });
                }
            }
        };

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) {
                return 'just now';
            } else if (minutes < 60) {
                return `${minutes}m ago`;
            } else if (hours < 24) {
                return `${hours}h ago`;
            } else if (days < 7) {
                return `${days}d ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
            }
        }
    </script>
</body>
</html>
