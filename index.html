<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Real-Time Feed</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1d29;
        }
        /* Custom scrollbar for message box */
        #feed-container::-webkit-scrollbar {
            width: 8px;
        }
        #feed-container::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        #feed-container::-webkit-scrollbar-track {
            background-color: #2d3142;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start py-8">

    <div class="w-full max-w-lg">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-100">Town Square <span class="text-indigo-400">ðŸ›–ðŸ’¬</span></h1>
            <p id="user-info" class="text-sm text-gray-400 mt-1"></p>
        </header>

        <!-- Connection Status & Message Feed -->
        <div id="connection-status" class="text-center py-2 px-4 mb-4 text-xs font-medium rounded-lg shadow-sm">
            Attempting to connect...
        </div>

        <div id="feed-container" class="bg-[#252836] p-4 rounded-xl shadow-lg h-[60vh] overflow-y-auto mb-6 border border-gray-700 space-y-4">
            <!-- Messages will be appended here -->
            <p class="text-center text-gray-500 p-8">Waiting for connection to server...</p>
        </div>

        <!-- Input Form -->
        <form id="post-form" class="flex p-4 bg-[#252836] rounded-xl shadow-xl border border-indigo-800/50">
            <input
                type="text"
                id="message-input"
                placeholder="What's happening in the world?"
                autocomplete="off"
                class="flex-grow p-3 text-gray-100 bg-[#1e2130] border border-gray-600 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 disabled:bg-gray-800 disabled:text-gray-500 placeholder-gray-500"
                required
                disabled
            >
            <button
                type="submit"
                id="send-button"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-r-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg disabled:bg-indigo-900 disabled:text-gray-500"
                disabled
            >
                Post
            </button>
        </form>
    </div>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script>
        // --- CLIENT-SIDE LOGIC ---

        // 1. DOM Elements
        const feedContainer = document.getElementById('feed-container');
        const postForm = document.getElementById('post-form');
        const messageInput = document.getElementById('message-input');
        const userInfo = document.getElementById('user-info');
        const sendButton = document.getElementById('send-button');
        const connectionStatus = document.getElementById('connection-status');

        // 2. Nickname Generation
        const generateNickname = () => {
            const adjectives = ['Curious', 'Witty', 'Silent', 'Swift', 'Bright', 'Clever', 'Agile', 'Vivid'];
            const nouns = ['Panda', 'Eagle', 'Octopus', 'Raven', 'Whale', 'Llama', 'Tiger', 'Shark'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const number = Math.floor(Math.random() * 900) + 100;
            return `${adj}${noun}-${number}`;
        };

        const myNickname = generateNickname();
        userInfo.textContent = `You are connected as: ${myNickname}`;

        // 3. Socket.IO Connection Setup
        // Dynamically detect server URL for phone access
        const getServerUrl = () => {
            // Check for URL parameter first (e.g., ?server=http://192.168.1.100:3000)
            const urlParams = new URLSearchParams(window.location.search);
            const serverParam = urlParams.get('server');
            if (serverParam) {
                localStorage.setItem('serverUrl', serverParam);
                return serverParam;
            }
            
            // Check localStorage for saved server URL
            const savedUrl = localStorage.getItem('serverUrl');
            if (savedUrl) {
                return savedUrl;
            }
            
            // If page is served from a server (not file://), use same hostname and port
            if (window.location.protocol !== 'file:') {
                const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
                const hostname = window.location.hostname;
                const port = window.location.port || (protocol === 'https:' ? '443' : '80');
                // If port is default, use 3000 for Socket.IO server
                const serverPort = (port === '80' || port === '443') ? '3000' : port;
                return `${protocol}//${hostname}:${serverPort}`;
            }
            
            // Fallback to Render deployment
            return ' ?server=https://townsqr-3.onrender.com';
        };
        
        const SERVER_URL = getServerUrl();
        const socket = io(SERVER_URL);

        // --- Connection Status Handlers ---

        // Store post elements by ID for deletion
        const postElements = new Map();

        const updateStatus = (message, className, enableControls = false) => {
            connectionStatus.textContent = message;
            connectionStatus.className = `text-center py-2 px-4 mb-4 text-xs font-medium rounded-lg shadow-sm ${className}`;
            
            messageInput.disabled = !enableControls;
            sendButton.disabled = !enableControls;
            
            if (enableControls) {
                // Clear initial placeholder text if present
                if (feedContainer.firstElementChild && feedContainer.firstElementChild.classList.contains('text-center')) {
                    feedContainer.innerHTML = '';
                }
            }
        };

        socket.on('connect', () => {
            updateStatus('Connected to the Global Feed!', 'bg-green-900/30 text-green-400 border border-green-800/50', true);
            
            // Send a notification that the user joined
            socket.emit('new_post', {
                sender: 'System', 
                content: `${myNickname} has entered the chat.`,
                isSystem: true
            });
        });

        // Handle initial posts from server (if any)
        socket.on('initial_posts', (posts) => {
            if (posts && posts.length > 0) {
                // Clear the waiting message
                if (feedContainer.firstElementChild && feedContainer.firstElementChild.classList.contains('text-center')) {
                    feedContainer.innerHTML = '';
                }
                // Render all initial posts
                posts.forEach(post => {
                    renderPost(post);
                });
            }
        });

        socket.on('disconnect', () => {
            updateStatus('Disconnected. Please restart the server.', 'bg-red-900/30 text-red-400 border border-red-800/50', false);
        });

        socket.on('connect_error', (err) => {
            updateStatus(`Connection Error: Check if server is running on ${SERVER_URL}. Use ?server=https://townsqr-3.onrender.com in URL to configure.`, 'bg-yellow-900/30 text-yellow-400 border border-yellow-800/50', false);
            console.error('Socket.IO Connection Error:', err);
            console.log('Current server URL:', SERVER_URL);
        });

        // --- Message Rendering Function ---

        const renderPost = (data) => {
            const post = document.createElement('div');
            
            // Generate a temporary ID if not provided (for optimistic updates)
            const postId = data.id || `temp-${Date.now()}-${Math.random()}`;
            post.setAttribute('data-post-id', postId);
            
            // Basic class structure for a post
            post.classList.add('p-3', 'rounded-lg', 'break-words', 'shadow-sm', 'transition', 'duration-150', 'relative', 'group');

            let senderClass, contentClass, senderName, deleteButtonHtml = '';

            if (data.isSystem) {
                // System message styling
                senderName = 'System';
                senderClass = 'text-gray-400 italic';
                contentClass = 'text-gray-400 text-sm';
                post.classList.add('bg-[#1e2130]', 'border', 'border-gray-700/50');
            } else if (data.sender === myNickname) {
                // My message styling
                senderName = 'You';
                senderClass = 'font-bold text-indigo-400';
                contentClass = 'text-gray-200';
                post.classList.add('bg-indigo-900/20', 'border', 'border-indigo-700/50');
                // Add delete button for user's own posts
                deleteButtonHtml = `
                    <button 
                        class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-150 text-red-400 hover:text-red-300 bg-red-900/20 hover:bg-red-900/30 rounded-full p-1.5 text-xs font-semibold"
                        onclick="deletePost('${postId}')"
                        title="Delete post"
                    >
                        âœ•
                    </button>
                `;
            } else {
                // Other user message styling
                senderName = data.sender;
                senderClass = 'font-semibold text-gray-300';
                contentClass = 'text-gray-300';
                post.classList.add('bg-[#1e2130]', 'border', 'border-gray-700/50');
            }

            post.innerHTML = `
                ${deleteButtonHtml}
                <div class="${senderClass} text-xs mb-1">@${senderName}</div>
                <p class="${contentClass}">${data.content}</p>
            `;
            
            feedContainer.appendChild(post);
            
            // Store the post element by ID for deletion
            postElements.set(postId, post);
            
            // Auto-scroll to the bottom of the feed
            feedContainer.scrollTop = feedContainer.scrollHeight;
        };

        // --- Delete Post Function ---
        window.deletePost = function(postId) {
            if (socket.connected && postId) {
                // Remove 'temp-' prefix if it's a temporary ID (optimistic update)
                const actualPostId = postId.startsWith('temp-') ? null : postId;
                
                if (actualPostId) {
                    // Emit delete event to server
                    socket.emit('delete_post', actualPostId);
                } else {
                    // For temporary posts, just remove from UI
                    const postElement = postElements.get(postId);
                    if (postElement) {
                        postElement.remove();
                        postElements.delete(postId);
                    }
                }
            }
        };
        
        // --- Sending Logic (Client-to-Server) ---

        postForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const content = messageInput.value.trim();

            if (content && socket.connected) {
                const payload = {
                    sender: myNickname,
                    content: content,
                    isSystem: false
                };
                
                // Emit the new post event to the server
                socket.emit('new_post', payload);
                
                // Immediately render the post on the sender's screen (optimistic update)
                renderPost(payload);
                
                messageInput.value = '';
                messageInput.focus();
            }
        });

        // --- Receiving Logic (Server-to-Client) ---

        socket.on('new_post', (data) => {
            // If this is our own post, update the temporary ID with the real ID from server
            if (data.sender === myNickname && data.id) {
                // Find the most recent post from this user without an ID
                const tempPosts = Array.from(feedContainer.children).filter(child => {
                    const postId = child.getAttribute('data-post-id');
                    return postId && postId.startsWith('temp-') && child.querySelector('.text-indigo-400');
                });
                
                if (tempPosts.length > 0) {
                    const tempPost = tempPosts[tempPosts.length - 1];
                    const tempId = tempPost.getAttribute('data-post-id');
                    tempPost.setAttribute('data-post-id', data.id);
                    
                    // Update the delete button with the real ID
                    const deleteBtn = tempPost.querySelector('button');
                    if (deleteBtn) {
                        deleteBtn.setAttribute('onclick', `deletePost('${data.id}')`);
                    }
                    
                    // Update the map
                    postElements.delete(tempId);
                    postElements.set(data.id, tempPost);
                }
            } else if (data.sender !== myNickname) {
                // Render posts from other users
                renderPost(data);
            }
        });

        // --- Handle Post Deletion from Server ---
        socket.on('post_deleted', (postId) => {
            const postElement = postElements.get(postId);
            if (postElement) {
                // Add fade-out animation
                postElement.style.opacity = '0';
                postElement.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    postElement.remove();
                    postElements.delete(postId);
                }, 200);
            }
        });
        
    </script>
</body>
</html>